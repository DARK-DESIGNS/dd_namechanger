--███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--
--█░░░░░░░░░░░░███░░░░░░░░░░░░░░█░░░░░░░░░░░░░░░░███░░░░░░██░░░░░░░░████░░░░░░░░░░░░███░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░██████████░░░░░░█░░░░░░░░░░░░░░█--
--█░░▄▀▄▀▄▀▄▀░░░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀░░██░░▄▀▄▀░░████░░▄▀▄▀▄▀▄▀░░░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░░░░░░░░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█--
--█░░▄▀░░░░▄▀▄▀░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░██░░▄▀░░░░████░░▄▀░░░░▄▀▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░░░▄▀░░░░█░░▄▀░░░░░░░░░░█░░▄▀▄▀▄▀▄▀▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█--
--█░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░████░░▄▀░░███░░▄▀░░██░░▄▀░░██████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░███████████░░▄▀░░███░░▄▀░░█████████░░▄▀░░░░░░▄▀░░██░░▄▀░░█░░▄▀░░█████████--
--█░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░▄▀░░██████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░███░░▄▀░░███░░▄▀░░█████████░░▄▀░░██░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█--
--█░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░██████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░███░░▄▀░░███░░▄▀░░██░░░░░░█░░▄▀░░██░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█--
--█░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░▄▀░░░░███░░▄▀░░░░░░▄▀░░██████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░░░░░░░░░▄▀░░███░░▄▀░░███░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░██░░▄▀░░█░░░░░░░░░░▄▀░░█--
--█░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█████░░▄▀░░██░░▄▀░░██████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████████████░░▄▀░░███░░▄▀░░███░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░░░░░▄▀░░█████████░░▄▀░░█--
--█░░▄▀░░░░▄▀▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░░░░░█░░▄▀░░██░░▄▀░░░░████░░▄▀░░░░▄▀▄▀░░█░░▄▀░░░░░░░░░░█░░░░░░░░░░▄▀░░█░░░░▄▀░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░██░░▄▀▄▀▄▀▄▀▄▀░░█░░░░░░░░░░▄▀░░█--
--█░░▄▀▄▀▄▀▄▀░░░░█░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀▄▀░░████░░▄▀▄▀▄▀▄▀░░░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░░░░░░░░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█--
--█░░░░░░░░░░░░███░░░░░░██░░░░░░█░░░░░░██░░░░░░░░░░█░░░░░░██░░░░░░░░████░░░░░░░░░░░░███░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░██████████░░░░░░█░░░░░░░░░░░░░░█--
--███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--

-- == -- Locals -- == --

local nuiActive = false

-- == -- Framework -- == --

print("^2JOIN DISCORD: ^4https://discord.gg/J5EEGnfhuE")

if string.upper(Config.Framework) == "QBCORE" then

    if Config.Debug then
        print("^2FRAMEWORK SET TO ^4QBCORE")
    end

    QBCore = exports['qb-core']:GetCoreObject()

elseif string.upper(Config.Framework) == "ESX" then

    if Config.Debug then
        print("^2FRAMEWORK SET TO ^4ESX")
    end

    ESX = exports["es_extended"]:getSharedObject()

else

    if Config.Debug then
        print("^1ERROR! FRAMEWORK IS ^3NOT ^1SUPPORTED")
        print("^3" .. string.upper(GetCurrentResourceName()) .. " ^1HAS BEEN STOPPED!!!")
    end

    return

end

-- == -- functions -- == --

local function notify(msg, duration, msgtype)

    if string.upper(Config.Framework) == "QBCORE" then

        QBCore.Functions.Notify(msg, msgtype, duration)

    elseif string.upper(Config.Framework) == "ESX" then

        ESX.ShowNotification(msg, msgtype, duration)

    end

end

local function showInfobar(msg)

    CurrentActionMsg  = msg
    SetTextComponentFormat('STRING')
    AddTextComponentString(CurrentActionMsg)
    DisplayHelpTextFromStringLabel(0, 0, 1, -1)
   
end

local function showSubtitle(message, duration)
    BeginTextCommandPrint("STRING")
    AddTextComponentSubstringPlayerName(message)
    EndTextCommandPrint(duration, 1)
end

local function toggleNUI(bool)

    if bool ~= nil then

        if bool then

            nuiActive = true
            SendNUIMessage({menu = "show"; })
            SetNuiFocus(true, true)

        else

            nuiActive = false
            SendNUIMessage({menu = "hide"; })
            SetNuiFocus(false, false)

        end

    else

        if nuiActive then

            nuiActive = false
            SendNUIMessage({menu = "hide"; })
            SetNuiFocus(false, false)

        else

            nuiActive = true
            SendNUIMessage({menu = "show"; })
            SetNuiFocus(true, true)

        end

    end

end

-- == -- Script -- == --

Citizen.CreateThread(function()

    local blip = AddBlipForCoord(Config.Blip.coords)
    SetBlipSprite(blip, Config.Blip.sprite)
    SetBlipColour(blip, Config.Blip.color)
    SetBlipScale(blip, Config.Blip.size)
    SetBlipDisplay(blip, 2)
    SetBlipAsShortRange(blip, true)
    BeginTextCommandSetBlipName("STRING")
    AddTextComponentString(translate("blip_label"))
    EndTextCommandSetBlipName(blip)

    while true do

        playerPed = PlayerPedId()
        playerPos = GetEntityCoords(playerPed)

        if Vdist(playerPos, Config.Blip.coords) < 20.0 then

            DrawMarker(Config.Marker.type, Config.Blip.coords, 0, 0, 0, 0, 0, 0, 0.4, 0.4, 0.4, Config.Marker.color.r, Config.Marker.color.g, Config.Marker.color.b, Config.Marker.color.a, true, true, 2, true, nil, nil, false)

            if Vdist(playerPos, Config.Blip.coords) < 1.0 then

                showInfobar(translate("infobar_open_menu"))

                if IsControlJustReleased(0, 38) then

                    toggleNUI(true)

                end

            end

        end

        Citizen.Wait(1)

    end

end)

-- == -- Events -- == --

RegisterNetEvent("dd_namechanger:client:notify", function(data)

    notify(data.msg, data.duration, data.msgType)

end)

-- == -- NUI Callbacks -- == --

RegisterNUICallback("exit", function(data, cb)
    cb({})

    toggleNUI(false)

end)

RegisterNUICallback("submit", function(data, cb)
    cb({})

    if Config.Debug then

        print("^2DEBUG: ^4" .. json.encode(data))

    end

    toggleNUI(false)

    if data.firstname ~= "" and data.lastname ~= "" then

        TriggerServerEvent("dd_namechanger:server:changeName", data)

    else

        notify(translate("notification_no_input"), 5000, "error")

    end

end)